@page "/gestao/categorias"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Administrador,Funcionario")]
@using MyMedia.Domain.Entities
@inject MyMEDIA.GestaoLoja.Services.CategoriaBackofficeService Service

<h3>Categorias</h3>

@if (!string.IsNullOrWhiteSpace(Error))
{
    <div class="alert alert-danger">@Error</div>
}
@if (!string.IsNullOrWhiteSpace(Success))
{
    <div class="alert alert-success">@Success</div>
}

<div class="d-flex gap-2 mb-3">
    <button class="btn btn-primary" @onclick="AbrirCriar">Nova Categoria</button>
    <button class="btn btn-outline-secondary" @onclick="Reload">Atualizar</button>
</div>

<table class="table table-striped table-sm align-middle">
    <thead>
        <tr>
            <th>#</th>
            <th>Nome</th>
            <th style="width:220px;">Ações</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var c in Items)
        {
            <tr>
                <td>@c.Id</td>
                <td>@c.Nome</td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary me-1" @onclick="() => AbrirEditar(c)">Editar</button>
                    <button class="btn btn-sm btn-outline-danger" @onclick="() => AbrirApagar(c)">Apagar</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@* Modal Criar/Editar *@
@if (ShowEditModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@ModalTitle</h5>
                    <button type="button" class="btn-close" @onclick="FecharEdit"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label">Nome</label>
                    <input class="form-control" @bind="NomeEdit" @bind:event="oninput" />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="FecharEdit">Cancelar</button>
                    <button class="btn btn-primary" @onclick="GuardarEdit">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal Apagar *@
@if (ShowDeleteModal && Selected is not null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Apagar Categoria</h5>
                    <button type="button" class="btn-close" @onclick="FecharApagar"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Apagar a categoria <strong>@Selected.Nome</strong>?</p>
                    <div class="alert alert-warning mt-3 mb-0">
                        Só é possível apagar se não existirem produtos nesta categoria.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="FecharApagar">Cancelar</button>
                    <button class="btn btn-danger" @onclick="ConfirmarApagar">Sim, apagar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    List<Categoria> Items = new();
    string? Error;
    string? Success;

    // modais
    bool ShowEditModal;
    bool ShowDeleteModal;
    string ModalTitle = "Nova Categoria";
    string NomeEdit = "";
    Categoria? Selected;
    bool IsEdit;

    protected override async Task OnInitializedAsync()
        => await Reload();

    async Task Reload()
    {
        Error = null; Success = null;
        Items = await Service.ListAsync();
    }

    void AbrirCriar()
    {
        IsEdit = false;
        Selected = null;
        NomeEdit = "";
        ModalTitle = "Nova Categoria";
        ShowEditModal = true;
    }

    void AbrirEditar(Categoria c)
    {
        IsEdit = true;
        Selected = c;
        NomeEdit = c.Nome;
        ModalTitle = $"Editar Categoria #{c.Id}";
        ShowEditModal = true;
    }

    void FecharEdit() => ShowEditModal = false;

    async Task GuardarEdit()
    {
        try
        {
            Error = null; Success = null;

            if (IsEdit && Selected is not null)
            {
                await Service.UpdateAsync(Selected.Id, NomeEdit);
                Success = "Categoria atualizada.";
            }
            else
            {
                await Service.AddAsync(NomeEdit);
                Success = "Categoria criada.";
            }

            ShowEditModal = false;
            await Reload();
        }
        catch (Exception ex) { Error = ex.Message; }
    }

    void AbrirApagar(Categoria c)
    {
        Selected = c;
        ShowDeleteModal = true;
    }

    void FecharApagar()
    {
        ShowDeleteModal = false;
        Selected = null;
    }

    async Task ConfirmarApagar()
    {
        try
        {
            if (Selected is null) return;
            await Service.DeleteAsync(Selected.Id);
            Success = "Categoria apagada.";
            FecharApagar();
            await Reload();
        }
        catch (Exception ex) { Error = ex.Message; }
    }
}