@page "/gestao/utilizadores"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Administrador,Funcionario")]
@using System.Security.Claims
@using MyMedia.Domain
@inject MyMEDIA.GestaoLoja.Services.UserBackofficeService Service
@inject AuthenticationStateProvider AuthStateProvider

<h3>Gestão de Utilizadores</h3>

<div class="row g-2 mb-3">
    <div class="col-12 col-md-4">
        <input class="form-control" placeholder="Pesquisar (email/nome)..."
               @bind="Q" @bind:event="oninput" />
    </div>

    <div class="col-12 col-md-4">
        <select class="form-select" @bind="Role">
            <option value="">-- Role --</option>
            <option value="Cliente">Cliente</option>
            <option value="Fornecedor">Fornecedor</option>
            <option value="Funcionario">Funcionario</option>
            <option value="Administrador">Administrador</option>
        </select>
    </div>

    <div class="col-12 col-md-2">
        <select class="form-select" @bind="Estado">
            <option value="">-- Estado --</option>
            <option value="Pendente">Pendente</option>
            <option value="Ativo">Ativo</option>
            <option value="Inativo">Inativo</option>
        </select>
    </div>

    <div class="col-12 col-md-2 d-grid">
        <button class="btn btn-primary" @onclick="Reload">Filtrar</button>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(Error))
{
    <div class="alert alert-danger">@Error</div>
}
@if (!string.IsNullOrWhiteSpace(Success))
{
    <div class="alert alert-success">@Success</div>
}

<table class="table table-striped table-sm align-middle">
    <thead>
        <tr>
            <th>Email</th>
            <th>Nome</th>
            <th>Estado</th>
            <th>Roles</th>
            <th style="width: 420px;">Ações</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var u in Items)
        {
            <tr>
                <td>@u.Email</td>
                <td>@u.Nome @u.Apelido</td>
                <td>@u.Estado</td>
                <td>@string.Join(", ", RolesMap.TryGetValue(u.Id, out var r) ? r : new List<string>())</td>
                <td>
                    @if (u.Id == CurrentUserId)
                    {
                        <span class="text-muted">Sem ações (você)</span>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-success me-1" @onclick='() => AbrirEstado(u, "Ativo")'>Ativar</button>
                        <button class="btn btn-sm btn-warning me-1" @onclick='() => AbrirEstado(u, "Pendente")'>Pendente</button>
                        <button class="btn btn-sm btn-outline-danger me-2" @onclick='() => AbrirEstado(u, "Inativo")'>Inativar</button>

                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => AbrirRole(u)">
                            Alterar Role
                        </button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="d-flex justify-content-between align-items-center">
    <div>Total: @Total</div>
    <div class="btn-group">
        <button class="btn btn-outline-secondary" disabled="@(!CanPrev)" @onclick="Prev">Anterior</button>
        <button class="btn btn-outline-secondary" disabled="@(!CanNext)" @onclick="Next">Seguinte</button>
    </div>
</div>

@* Modal Estado *@
@if (ShowEstadoModal && UserSel is not null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alterar Estado</h5>
                    <button type="button" class="btn-close" @onclick="FecharEstado"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">
                        Alterar estado de <strong>@UserSel.Email</strong> para <strong>@NovoEstado</strong>?
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="FecharEstado">Cancelar</button>
                    <button class="btn btn-primary" @onclick="ConfirmarEstado">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal Role *@
@if (ShowRoleModal && UserSel is not null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Alterar Role</h5>
                    <button type="button" class="btn-close" @onclick="FecharRole"></button>
                </div>
                <div class="modal-body">
                    <p>Utilizador: <strong>@UserSel.Email</strong></p>

                    <label class="form-label">Nova role</label>
                    <select class="form-select" @bind="NovaRole">
                        <option value="Cliente">Cliente</option>
                        <option value="Fornecedor">Fornecedor</option>
                        <option value="Funcionario" disabled="@(!IsAdmin)">Funcionario (só Admin)</option>
                        <option value="Administrador" disabled="@(!IsAdmin)">Administrador (só Admin)</option>
                    </select>

                    @if (!IsAdmin)
                    {
                        <div class="form-text">
                            Apenas Administrador pode atribuir/remover Funcionário/Administrador.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="FecharRole">Cancelar</button>
                    <button class="btn btn-primary" @onclick="ConfirmarRole">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    string? Q;
    string? Role;
    string? Estado;

    int Page = 1;
    const int PageSize = 10;
    int Total;
    bool CanPrev => Page > 1;
    bool CanNext => (Page * PageSize) < Total;

    List<ApplicationUser> Items = new();
    Dictionary<string, IList<string>> RolesMap = new();

    string? Error;
    string? Success;

    string CurrentUserId = "";
    bool IsAdmin;

    // modais
    bool ShowEstadoModal;
    bool ShowRoleModal;
    ApplicationUser? UserSel;
    string NovoEstado = "Ativo";
    string NovaRole = "Cliente";

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = auth.User;
        CurrentUserId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
        IsAdmin = user.IsInRole("Administrador");

        await Reload();
    }

    async Task Reload()
    {
        Error = null; Success = null;

        var (items, total) = await Service.SearchAsync(Q, Role, Estado, Page, PageSize);
        Items = items;
        Total = total;

        RolesMap.Clear();
        foreach (var u in Items)
            RolesMap[u.Id] = await Service.GetRolesAsync(u);
    }

    async Task Prev() { if (!CanPrev) return; Page--; await Reload(); }
    async Task Next() { if (!CanNext) return; Page++; await Reload(); }

    void AbrirEstado(ApplicationUser u, string novoEstado)
    {
        UserSel = u;
        NovoEstado = novoEstado;
        ShowEstadoModal = true;
    }
    void FecharEstado() { ShowEstadoModal = false; UserSel = null; }

    async Task ConfirmarEstado()
    {
        try
        {
            if (UserSel is null) return;

            await Service.SetEstadoAsync(UserSel.Id, NovoEstado, CurrentUserId);
            Success = $"Estado atualizado: {UserSel.Email} -> {NovoEstado}";
            FecharEstado();
            await Reload();
        }
        catch (Exception ex) { Error = ex.Message; }
    }

    void AbrirRole(ApplicationUser u)
    {
        UserSel = u;
        NovaRole = "Cliente";
        ShowRoleModal = true;
    }
    void FecharRole() { ShowRoleModal = false; UserSel = null; }

    async Task ConfirmarRole()
    {
        try
        {
            if (UserSel is null) return;

            if (!IsAdmin && (NovaRole is "Funcionario" or "Administrador"))
                throw new InvalidOperationException("Apenas Administrador pode atribuir Funcionário/Administrador.");

            await Service.SetRoleAsync(UserSel.Id, NovaRole);
            Success = $"Role atualizada: {UserSel.Email} -> {NovaRole}";
            FecharRole();
            await Reload();
        }
        catch (Exception ex) { Error = ex.Message; }
    }
}