@page "/registo"

@using System.ComponentModel.DataAnnotations
@using System.Net
@using RCLAPI.DTOs
@using RCLAPI.Services
@inject ApiService Api
@inject NavigationManager Nav

<div class="text-center mb-4">
    <img src="_content/RCLComum/images/logo.png" alt="MyMEDIA" style="height:60px;" />
    <h3>Registo</h3>
</div>

<EditForm Model="@vm" OnValidSubmit="HandleRegisto">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Email</label>
        <InputText class="form-control" @bind-Value="vm.Email" />
    </div>

    <div class="mb-3">
        <label class="form-label">Password</label>
        <InputText class="form-control" type="password" @bind-Value="vm.Password" />
    </div>

    <div class="mb-3">
        <label class="form-label">Tipo de utilizador</label>
        <InputSelect class="form-select" @bind-Value="vm.Role">
            <option value="Cliente">Cliente</option>
            <option value="Fornecedor">Fornecedor</option>
        </InputSelect>
    </div>

    <hr />

    <div class="row g-2">
        <div class="col-md-6">
            <label class="form-label">Nome</label>
            <InputText class="form-control" @bind-Value="vm.Nome" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Apelido</label>
            <InputText class="form-control" @bind-Value="vm.Apelido" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Data de nascimento</label>
            <InputDate class="form-control" @bind-Value="vm.DataNascimento" />
        </div>
        <div class="col-md-6">
            <label class="form-label">NIF</label>
            <InputNumber class="form-control" @bind-Value="vm.NIF" />
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger mt-3">@error</div>
    }

    @if (!string.IsNullOrWhiteSpace(success))
    {
        <div class="alert alert-success mt-3">@success</div>
    }

    <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary" disabled="@isBusy">
            @(isBusy ? "A criar conta..." : "Registar")
        </button>

        <button type="button" class="btn btn-outline-secondary" @onclick="GoLogin" disabled="@isBusy">
            Ir para Login
        </button>
    </div>
</EditForm>

@code {
    private RegisterVm vm = new();
    private bool isBusy;
    private string? error;
    private string? success;

    private async Task HandleRegisto()
    {
        error = null;
        success = null;
        isBusy = true;

        try
        {
            var dto = new RegistoDTO
            {
                Email = vm.Email,
                Password = vm.Password,
                Role = vm.Role,
                Nome = vm.Nome ?? "",
                Apelido = vm.Apelido ?? "",
                DataNascimento = vm.DataNascimento,
                NIF = vm.NIF
            };

            var rsp = await Api.RegistoAsync(dto);
            var body = await rsp.Content.ReadAsStringAsync();

            if (rsp.IsSuccessStatusCode)
            {
                success = "Conta criada com sucesso e ficou Pendente. Aguarde ativação. A redirecionar para o login...";
                await Task.Delay(800);
                Nav.NavigateTo("/login");
                return;
            }

            // erros mais legíveis
            if (!string.IsNullOrWhiteSpace(body))
                error = body;
            else
                error = $"Não foi possível registar. HTTP {(int)rsp.StatusCode}.";
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

    private void GoLogin() => Nav.NavigateTo("/login");

    private sealed class RegisterVm
    {
        [Required, EmailAddress]
        public string Email { get; set; } = "";

        [Required, MinLength(6)]
        public string Password { get; set; } = "";

        [Required]
        public string Role { get; set; } = "Cliente";

        public string? Nome { get; set; }
        public string? Apelido { get; set; }
        public DateTime? DataNascimento { get; set; }
        public int? NIF { get; set; }
    }
}