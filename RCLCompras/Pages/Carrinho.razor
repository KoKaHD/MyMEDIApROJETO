@page "/carrinho"

@inject ApiService Api
@inject TokenService TokenSvc
@inject NavigationManager Nav

<header class="page-head">
    <h3 class="page-title">Carrinho</h3>
</header>

@if (itens == null)
{
    <p>A carregar...</p>
}
else if (!itens.Any())
{
    <div class="empty-state">
        <h5>O carrinho está vazio.</h5>
        <button class="btn btn-primary" @onclick="() => Nav.NavigateTo(" /produtos")">
            Ver produtos
        </button>
    </div>
}
else
{
    <div class="cart-layout">
        <section class="cart-items">
            @foreach (var item in itens)
            {
                <CarrinhoItem Item="item"
                              OnRemoved="RemoveItem"
                              OnChanged="UpdateItem" />
            }
        </section>

        <aside class="cart-summary">
            <div class="summary-card">
                <h5>Resumo</h5>
                <div class="summary-line">
                    <span>Total</span>
                    <strong>€ @Total.ToString("0.00")</strong>
                </div>

                <button class="btn btn-success w-100" @onclick="GoCheckout">
                    Finalizar Encomenda
                </button>

                <button class="btn btn-outline-secondary w-100 mt-2" @onclick="ClearCart">
                    Limpar Carrinho
                </button>
            </div>
        </aside>
    </div>
}

@code {
    private List<CarrinhoDTO>? itens;
    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        userId = await TokenSvc.GetUserIdAsync();
        if (string.IsNullOrWhiteSpace(userId))
        {
            Nav.NavigateTo("/login");
            return;
        }

        itens = await Api.GetCarrinhoAsync(userId);
    }

    private decimal Total => itens?.Sum(i => i.Quantidade * i.ProdutoPreco) ?? 0;

    private async Task RemoveItem(CarrinhoDTO item)
    {
        await Api.RemoveCarrinhoAsync(item.Id);
        itens!.Remove(item);
        StateHasChanged();
    }

    private async Task UpdateItem(CarrinhoDTO item)
    {
        // garante mínimo 1
        if (item.Quantidade < 1) item.Quantidade = 1;

        await Api.UpdateCarrinhoAsync(item);
        StateHasChanged();
    }

    private async Task ClearCart()
    {
        await Api.ClearCarrinhoAsync(userId!);
        itens!.Clear();
    }

    private void GoCheckout() => Nav.NavigateTo("/checkout");
}