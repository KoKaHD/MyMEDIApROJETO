@page "/checkout"

@inject ApiService Api
@inject TokenService TokenSvc
@inject NavigationManager Nav

<header class="page-head">
    <h3 class="page-title">Finalizar Encomenda</h3>
</header>

@if (itens == null)
{
    <p>A carregar...</p>
}
else if (!itens.Any())
{
    <p>Carrinho vazio.</p>
}
else
{
    <div class="checkout-layout">
        <section class="checkout-resumo">
            <div class="summary-card">
                <h5>Resumo</h5>

                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th class="text-end">Qtd</th>
                                <th class="text-end">Preço</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var i in itens)
                            {
                                <tr>
                                    <td>@i.ProdutoNome</td>
                                    <td class="text-end">@i.Quantidade</td>
                                    <td class="text-end">€ @i.ProdutoPreco.ToString("0.00")</td>
                                    <td class="text-end">€ @(i.Quantidade* i.ProdutoPreco).ToString("0.00")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="summary-line">
                    <span>Total</span>
                    <strong>€ @Total.ToString("0.00")</strong>
                </div>

                <button class="btn btn-success w-100" @onclick="Finalizar" disabled="@isBusy">
                    @(isBusy ? "A processar..." : "Pagar (simulado)")
                </button>

                <button class="btn btn-outline-secondary w-100 mt-2" @onclick="Back" disabled="@isBusy">
                    Voltar
                </button>
            </div>
        </section>
    </div>
}

@code {
    private List<CarrinhoDTO>? itens;
    private string? userId;
    private bool isBusy;

    private decimal Total => itens?.Sum(i => i.Quantidade * i.ProdutoPreco) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        userId = await TokenSvc.GetUserIdAsync();
        if (string.IsNullOrWhiteSpace(userId))
        {
            Nav.NavigateTo("/login");
            return;
        }

        itens = await Api.GetCarrinhoAsync(userId);
    }

    private async Task Finalizar()
    {
        if (itens is null || itens.Count == 0) return;

        isBusy = true;
        try
        {
            var dto = new EncomendaDTO
            {
                ClienteId = userId!,
                PrecoTotal = Total,
                Estado = "Pendente",
                Detalhes = itens.Select(i => new DetalheEncomendaDTO
                {
                    ProdutoId = i.ProdutoId,
                    Quantidade = i.Quantidade,
                    PrecoUnitario = i.ProdutoPreco
                }).ToList()
            };

            await Api.FinalizarEncomendaAsync(dto);
            await Api.ClearCarrinhoAsync(userId!);

            Nav.NavigateTo("/encomendas");
        }
        finally
        {
            isBusy = false;
        }
    }

    private void Back() => Nav.NavigateTo("/carrinho");
}